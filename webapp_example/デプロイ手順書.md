# クラウドデプロイ手順書

## 📋 概要

このドキュメントでは、価格自動取得システムをクラウドにデプロイする手順を説明します。

## 🎯 推奨プラットフォーム

### 1. Render（推奨・無料枠あり）⭐

**メリット**:
- ✅ 無料枠あり（15分間の非アクティブ後にスリープ）
- ✅ セットアップが簡単
- ✅ GitHub連携で自動デプロイ
- ✅ 日本語対応

**費用**: 無料（試用）→ 約1,050円/月（Starterプラン）

---

### 2. Railway（簡単・無料クレジットあり）

**メリット**:
- ✅ $5/月の無料クレジット（約750円相当）
- ✅ セットアップが簡単
- ✅ GitHub連携で自動デプロイ

**費用**: 無料（試用）→ 約750円/月

---

### 3. Heroku（安定・有料）

**メリット**:
- ✅ 安定した動作
- ✅ 豊富なアドオン

**費用**: 約750-1,050円/月

---

## 🚀 Renderでのデプロイ手順（推奨）

### ステップ1: GitHubにリポジトリを作成

1. GitHubアカウントにログイン
2. 新しいリポジトリを作成
3. プロジェクトフォルダをGitリポジトリとして初期化

```bash
cd webapp_example
git init
git add .
git commit -m "Initial commit"
git branch -M main
git remote add origin https://github.com/あなたのユーザー名/リポジトリ名.git
git push -u origin main
```

### ステップ2: Renderでアプリを作成

1. [Render](https://render.com)にアクセスしてアカウントを作成
2. 「New +」→「Web Service」を選択
3. GitHubリポジトリを選択
4. 以下の設定を入力：

**基本設定**:
- **Name**: `price-scraper-app`（任意の名前）
- **Region**: `Singapore`（日本に近い）
- **Branch**: `main`
- **Root Directory**: `webapp_example`（または空白）

**ビルド設定**:
- **Build Command**: `pip install -r requirements_web.txt`
- **Start Command**: `gunicorn app:app --bind 0.0.0.0:$PORT --workers 2 --timeout 120`

**環境変数**:
- `FLASK_ENV`: `production`
- `PYTHON_VERSION`: `3.9.18`

5. 「Create Web Service」をクリック

### ステップ3: デプロイの確認

1. デプロイが完了するまで待機（約5-10分）
2. 表示されたURL（例: `https://price-scraper-app.onrender.com`）にアクセス
3. アプリが正常に動作するか確認

---

## 🚂 Railwayでのデプロイ手順

### ステップ1: GitHubにリポジトリを作成

（Renderと同じ手順）

### ステップ2: Railwayでアプリを作成

1. [Railway](https://railway.app)にアクセスしてアカウントを作成
2. 「New Project」→「Deploy from GitHub repo」を選択
3. GitHubリポジトリを選択
4. 自動的にデプロイが開始されます

**設定の確認**:
- Root Directory: `webapp_example`（必要に応じて設定）
- Start Command: `gunicorn app:app --bind 0.0.0.0:$PORT --workers 2 --timeout 120`

### ステップ3: 環境変数の設定

Railwayのダッシュボードで以下を設定：
- `FLASK_ENV`: `production`
- `PYTHON_VERSION`: `3.9.18`

### ステップ4: デプロイの確認

1. デプロイが完了するまで待機
2. 表示されたURLにアクセス
3. アプリが正常に動作するか確認

---

## 🔧 Herokuでのデプロイ手順

### ステップ1: Heroku CLIのインストール

```bash
# macOS
brew tap heroku/brew && brew install heroku

# または公式サイトからダウンロード
# https://devcenter.heroku.com/articles/heroku-cli
```

### ステップ2: Herokuにログイン

```bash
heroku login
```

### ステップ3: アプリを作成

```bash
cd webapp_example
heroku create price-scraper-app
```

### ステップ4: 環境変数の設定

```bash
heroku config:set FLASK_ENV=production
heroku config:set PYTHON_VERSION=3.9.18
```

### ステップ5: デプロイ

```bash
git add .
git commit -m "Deploy to Heroku"
git push heroku main
```

### ステップ6: デプロイの確認

```bash
heroku open
```

---

## 📝 デプロイ前の確認事項

### 1. 必要なファイルの確認

以下のファイルが`webapp_example`フォルダに存在することを確認：

- ✅ `app.py` - メインアプリケーション
- ✅ `requirements_web.txt` - 依存パッケージ
- ✅ `Procfile` - Heroku用の起動コマンド
- ✅ `runtime.txt` - Pythonバージョン指定
- ✅ `templates/index.html` - フロントエンド
- ✅ `config/` フォルダ（親ディレクトリから参照）

### 2. 設定ファイルのパス確認

`app.py`で設定ファイルを読み込む際のパスを確認：

```python
# 現在の設定（親ディレクトリから参照）
config_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'config', 'sites.yaml')
```

**注意**: デプロイ時は、`config`フォルダも一緒にデプロイする必要があります。

### 3. データベースの設定

- **開発環境**: SQLite（`prices.db`）
- **本番環境**: PostgreSQL（推奨）またはSQLite

Render/Railwayでは、PostgreSQLアドオンを追加することを推奨します。

---

## 🔧 トラブルシューティング

### デプロイが失敗する場合

1. **ログを確認**
   ```bash
   # Render
   Renderダッシュボードの「Logs」タブを確認
   
   # Railway
   Railwayダッシュボードの「Deployments」→「View Logs」を確認
   
   # Heroku
   heroku logs --tail
   ```

2. **依存パッケージの確認**
   - `requirements_web.txt`にすべての依存パッケージが含まれているか確認
   - バージョン指定が正しいか確認

3. **設定ファイルのパス確認**
   - `config`フォルダが正しくデプロイされているか確認
   - パスが正しいか確認

### アプリが起動しない場合

1. **ポート番号の確認**
   - 環境変数`PORT`が正しく設定されているか確認
   - `gunicorn`の`--bind`オプションが正しいか確認

2. **データベースの初期化**
   - 初回起動時にデータベースが作成されるか確認
   - エラーログを確認

### スクレイピングが動作しない場合

1. **タイムアウトの設定**
   - `gunicorn`の`--timeout`オプションを確認（現在120秒）
   - 必要に応じて延長

2. **メモリ使用量**
   - 無料プランではメモリ制限がある場合があります
   - ログでメモリエラーを確認

---

## 📊 デプロイ後の確認

### 1. 基本的な動作確認

- [ ] トップページが表示される
- [ ] 「実装済み18社の価格を取得」ボタンが表示される
- [ ] スクレイピングが実行される
- [ ] 結果が表示される
- [ ] Excelダウンロードが動作する

### 2. パフォーマンス確認

- [ ] スクレイピングが1-2分で完了する
- [ ] 複数のリクエストが正常に処理される
- [ ] エラーが発生しない

### 3. セキュリティ確認

- [ ] HTTPSでアクセスできる
- [ ] 環境変数が正しく設定されている
- [ ] データベースが保護されている

---

## 💡 次のステップ

### 1. カスタムドメインの設定

- Render/Railway/Herokuでカスタムドメインを設定可能
- 独自のドメイン名を使用できる

### 2. データベースの移行

- SQLiteからPostgreSQLへの移行を検討
- より安定した動作が期待できる

### 3. モニタリングの追加

- エラーログの監視
- パフォーマンスの監視
- アラートの設定

---

## 📞 サポート

デプロイで問題が発生した場合：

1. ログファイルを確認
2. エラーメッセージを確認
3. プラットフォームのドキュメントを参照
4. 必要に応じてサポートに問い合わせ

---

## ✅ チェックリスト

デプロイ前：
- [ ] GitHubリポジトリが作成されている
- [ ] すべてのファイルがコミットされている
- [ ] `requirements_web.txt`が最新である
- [ ] `Procfile`が正しく設定されている
- [ ] 環境変数が設定されている

デプロイ後：
- [ ] アプリが正常に起動している
- [ ] トップページが表示される
- [ ] スクレイピングが動作する
- [ ] 結果が正しく表示される
- [ ] Excelダウンロードが動作する

---

**最終更新**: 2025年11月16日



