<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>価格自動取得システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-progress { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>非鉄金属スクラップ価格自動取得システム</h1>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>スクレイピング実行</h5>
            </div>
            <div class="card-body">
                <button id="scrapeBtn" class="btn btn-primary" onclick="startScraping()">
                    実装済み18社の価格を取得
                </button>
                <div id="status" class="mt-3"></div>
                <div id="progress" class="mt-3"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between">
                <h5>最新の価格情報</h5>
                <button class="btn btn-sm btn-success" onclick="downloadExcel()">
                    Excelダウンロード
                </button>
            </div>
            <div class="card-body">
                <div id="results"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>各材料の最高価格</h5>
            </div>
            <div class="card-body">
                <div id="max-prices"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let scrapingInProgress = false;
        
        async function startScraping() {
            if (scrapingInProgress) {
                alert('スクレイピングは既に実行中です');
                return;
            }
            
            scrapingInProgress = true;
            document.getElementById('scrapeBtn').disabled = true;
            document.getElementById('status').innerHTML = '<span class="status-badge status-progress">実行中...</span>';
            document.getElementById('progress').innerHTML = '';
            
            try {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.status === 'completed') {
                    document.getElementById('status').innerHTML = 
                        `<span class="status-badge status-success">完了: ${data.total}社処理</span>`;
                    
                    // 結果を表示
                    let progressHtml = '<ul class="list-group">';
                    data.results.forEach(result => {
                        const statusClass = result.status === 'success' ? 'success' : 'error';
                        progressHtml += `<li class="list-group-item">
                            <span class="status-badge status-${statusClass}">${result.company}</span>
                            ${result.status === 'success' ? `${result.price_count}件取得` : result.error}
                        </li>`;
                    });
                    progressHtml += '</ul>';
                    document.getElementById('progress').innerHTML = progressHtml;
                    
                    // 結果を再読み込み
                    loadResults();
                    loadMaxPrices();
                }
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    `<span class="status-badge status-error">エラー: ${error.message}</span>`;
            } finally {
                scrapingInProgress = false;
                document.getElementById('scrapeBtn').disabled = false;
            }
        }
        
        async function loadMaxPrices() {
            try {
                const response = await fetch('/api/results/max-prices');
                const data = await response.json();
                
                if (data.length === 0) {
                    document.getElementById('max-prices').innerHTML = 
                        '<div class="alert alert-info">最高価格データがありません。先にスクレイピングを実行してください。</div>';
                    return;
                }
                
                let html = '<table class="table table-striped table-hover"><thead><tr>';
                html += '<th>材料名</th><th>最高価格</th><th>企業名</th><th>地域</th>';
                html += '</tr></thead><tbody>';
                
                data.forEach(item => {
                    html += `<tr>
                        <td><strong>${item.material}</strong></td>
                        <td><span class="badge bg-success" style="font-size: 1em;">${item.max_price}</span></td>
                        <td>${item.company}</td>
                        <td>${item.region || ''}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                document.getElementById('max-prices').innerHTML = html;
            } catch (error) {
                document.getElementById('max-prices').innerHTML = 
                    `<div class="alert alert-danger">エラー: ${error.message}</div>`;
            }
        }
        
        async function loadResults() {
            try {
                const response = await fetch('/api/results/latest');
                const data = await response.json();
                
                let html = '<table class="table table-striped"><thead><tr>';
                html += '<th>企業名</th><th>地域</th><th>材料名</th><th>価格</th><th>取得日時</th>';
                html += '</tr></thead><tbody>';
                
                data.forEach(company => {
                    Object.entries(company.prices).forEach(([material, price]) => {
                        html += `<tr>
                            <td>${company.company}</td>
                            <td>${company.region || ''}</td>
                            <td>${material}</td>
                            <td>${price}</td>
                            <td>${company.scraped_at ? new Date(company.scraped_at).toLocaleString('ja-JP') : ''}</td>
                        </tr>`;
                    });
                });
                
                html += '</tbody></table>';
                document.getElementById('results').innerHTML = html;
            } catch (error) {
                document.getElementById('results').innerHTML = 
                    `<div class="alert alert-danger">エラー: ${error.message}</div>`;
            }
        }
        
        function downloadExcel() {
            window.location.href = '/api/download/excel';
        }
        
        // ページ読み込み時に結果を表示
        loadResults();
        loadMaxPrices();
    </script>
</body>
</html>






