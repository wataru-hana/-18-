# 表形式出力システムの使い方

## 概要

価格自動抽出システムで取得した価格データを、Excelファイルの表形式シートに自動的に記入するシステムです。

## 機能

- **複数のExcelファイル・シートに対応**: 設定ファイルで複数の出力先を指定可能
- **自動マッピング**: 企業名と材料名を自動的にマッチング
- **表構造の自動検出**: ヘッダー行と企業名列を自動検出
- **柔軟な設定**: 有効/無効の切り替えが可能

## 設定方法

### 1. 設定ファイルの編集

`config/output_tables.yaml` を編集して、出力先のExcelファイルとシート名を指定します。

```yaml
output_tables:
  # 例1: プライステスト.xlsxの「１１０２７」シート
  - excel_file: "プライステスト.xlsx"
    sheet_name: "１１０２７"
    description: "プライステスト用の表"
    enabled: true  # true/falseで有効/無効を切り替え
  
  # 例2: 既存の「正規の表」シート
  - excel_file: "price_results_v2_20251104_220253.xlsx"
    sheet_name: "正規の表"
    description: "標準的な価格表"
    enabled: true
```

### 2. 表の構造

表は以下の構造である必要があります：

- **1行目**: ヘッダー行（材料名）
- **1列目**: 企業名列（2行目以降）
- **2列目以降**: 価格データ（企業名と材料の交差するセルに価格が記入される）

例：
```
        | ピカ銅 | 並銅 | 砲金 | ...
--------|--------|------|------|----
企業名1 |  850   | 800  | 750  | ...
企業名2 |  860   | 810  | 760  | ...
```

## 実行方法

### 方法1: 専用スクリプトを使用

```bash
python fill_table_formats.py
```

このスクリプトは：
1. 18社の価格を自動取得
2. `config/output_tables.yaml` で指定されたすべてのシートに価格を記入

### 方法2: 既存のスクリプトを使用

```bash
python scrape_and_fill_standard_table.py
```

このスクリプトも設定ファイルに対応しています。

## 動作の流れ

1. **価格の自動取得**: 実装済み18社の価格をスクレイピングで取得
2. **設定ファイルの読み込み**: `config/output_tables.yaml` から出力先を読み込み
3. **各シートへの記入**:
   - シート名を検索（全角・半角の数字に対応）
   - ヘッダー行から材料名を取得
   - 企業名列から既存の企業を検出
   - 取得した価格を該当セルに記入
   - 新しい企業の場合は行を追加
4. **ファイルの保存**: 各Excelファイルを保存

## 注意事項

- Excelファイルが開いている場合は保存に失敗する可能性があります
- シート名は完全一致または部分一致で検索されます
- 企業名と材料名は自動的に正規化されます（文字化け対応、表記ゆれ対応）
- `enabled: false` に設定すると、そのシートはスキップされます

## トラブルシューティング

### シートが見つからない場合

- シート名が正確か確認してください
- 全角・半角の違いを確認してください
- ログに「利用可能なシート」が表示されるので確認してください

### 価格が記入されない場合

- 材料名がヘッダーと一致しているか確認してください
- ログで「未マッチ」や「警告」メッセージを確認してください
- `config/target_items.yaml` の設定を確認してください

### ファイルが保存できない場合

- Excelファイルが開いていないか確認してください
- ファイルの書き込み権限を確認してください
- ファイルパスが正しいか確認してください



