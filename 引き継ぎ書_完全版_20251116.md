# 非鉄金属スクラップ価格自動取得システム - 完全引継書

**最終更新**: 2025年11月16日  
**作成者**: AI Assistant  
**バージョン**: 3.0

---

## 📋 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [実装状況サマリー](#実装状況サマリー)
3. [実装済み18社の詳細](#実装済み18社の詳細)
4. [システム構成](#システム構成)
5. [設定ファイルの詳細](#設定ファイルの詳細)
6. [スクリプトの使用方法](#スクリプトの使用方法)
7. [最新の更新内容（2025年11月16日）](#最新の更新内容2025年11月16日)
8. [重要な実装内容](#重要な実装内容)
9. [価格修正の適用方法](#価格修正の適用方法)
10. [トラブルシューティング](#トラブルシューティング)
11. [次のステップ](#次のステップ)

---

## 📊 プロジェクト概要

### 目的
非鉄金属スクラップの価格情報を複数の企業サイトから自動取得し、JSON/CSV/Excel形式で出力するシステム。

### 対象
- **総企業数**: 35社（PDFから確認済み）
- **実装済み**: 18社（全社で価格取得成功、価格修正マッピング適用済み）
- **未実装**: 17社（HTML構造分析や抽出ロジック改善が必要）
- **対象アイテム**: 13種類（ピカ銅、並銅、砲金、真鍮、雑線80%、雑線60%-65%、VA線、アルミホイール、アルミサッシ、アルミ缶　バラ、アルミ缶　プレス、ステンレス304、鉛バッテリー）

---

## ✅ 実装状況サマリー

| カテゴリ | 企業数 | 詳細 |
|---------|--------|------|
| **実装済み（動作確認済み）** | **18社** | 全社で価格取得成功、価格修正マッピング適用済み |
| **未実装** | 17社 | HTML構造分析や抽出ロジック改善が必要 |
| **合計** | **35社** | |

### 実装済み18社のリスト

1. 眞田鋼業株式会社
2. 有限会社金田商事
3. 木村金属（大阪）
4. 明鑫貿易株式会社
5. 東起産業（株）
6. 土金（大阪）
7. 大畑商事（千葉・大阪）
8. 千福商会（大阪）
9. 鴻祥貿易株式会社
10. 株式会社鳳山
11. 株式会社 春日商会　富山支店
12. 株式会社 春日商会　滋賀支店
13. 株式会社 春日商会　一宮本社
14. 安城貿易（愛知）
15. 東北キング
16. 株式会社八木
17. 有限会社　八尾アルミセンター
18. 株式会社 ヒラノヤ

---

## 🏢 実装済み18社の詳細

### カテゴリ1（1社）

#### 1. 有限会社　八尾アルミセンター
- **地域**: 大阪
- **抽出方法**: `div_list`
- **取得件数**: 10件（フィルタリング後）
- **特徴**: divカード形式
- **URL**: https://peraichi.com/landing_pages/view/yaoalumi/
- **価格修正**: 砲金(1460)、真鍮(1130)、雑線80%(1300)、雑線60%-65%(900)、アルミ缶　プレス(335)
- **削除対象**: 雑旋、鉛バッテリー、ステンレス304

### カテゴリ2（17社）

#### 2. 眞田鋼業株式会社
- **地域**: 大阪
- **抽出方法**: `auto`
- **取得件数**: 13件（フィルタリング後）
- **URL**: https://www.sanadakogyo.com/scrap_metal.html
- **価格修正**: 並銅(1500)、ステンレス304(160)

#### 3. 有限会社金田商事
- **地域**: 兵庫
- **抽出方法**: `kaneda_figcaption`（専用抽出ロジック）
- **取得件数**: 10件（フィルタリング後）
- **特徴**: figure > figcaption > div.span_9 > strongタグ構造
- **特別処理**: 税込変換、最高価格のみ抽出
- **URL**: https://www.kaneda-shouji.co.jp/product#a12
- **価格修正**: 並銅(1680)、真鍮(1180)、アルミサッシ(346)、アルミ缶　プレス(296)、ステンレス304(176)
- **削除対象**: 雑旋
- **注意**: VA線は記載がないため無記入でOK

#### 4. 木村金属（大阪）
- **地域**: 大阪
- **抽出方法**: `auto`
- **取得件数**: 6件（フィルタリング後）
- **URL**: https://kimura-metal.co.jp/price.html#07-01
- **価格修正**: 波銅→並銅(1640)
- **削除対象**: 雑旋、ステンレス304

#### 5. 明鑫貿易株式会社
- **地域**: 愛知
- **抽出方法**: `auto`
- **取得件数**: 13件（フィルタリング後）
- **URL**: https://www.meikinboueki.com/
- **価格修正**: ピカ銅(1690)、雑線80%(1250)、雑線60%-65%(910)、アルミサッシ(360)、アルミ缶　バラ(240)、アルミ缶　プレス(280)、ステンレス304(150)

#### 6. 東起産業（株）
- **地域**: 香川
- **抽出方法**: `touki_dl`（専用抽出ロジック）
- **取得件数**: 12件（フィルタリング後）
- **URL**: https://touki-sangyou.co.jp/
- **価格修正**: ピカ銅(1730)、砲金(1450)、雑線60%-65%(950)、VA線(710)、アルミホイール(400)、アルミサッシ(380)、ステンレス304(170)

#### 7. 土金（大阪）
- **地域**: 大阪
- **抽出方法**: `auto`
- **取得件数**: 12件（フィルタリング後）
- **URL**: https://www.dokindokin.com/scrap/
- **価格修正**: 真鍮(1090)、VA線(740)、アルミ缶　バラ(150)、アルミ缶　プレス(240)

#### 8. 大畑商事（千葉・大阪）
- **地域**: 大阪
- **抽出方法**: `auto`
- **取得件数**: 1件（フィルタリング後）
- **URL**: https://www.ohata.org/kakaku.html

#### 9. 千福商会（大阪）
- **地域**: 大阪
- **抽出方法**: `auto`
- **取得件数**: 12件（フィルタリング後）
- **URL**: https://www.senfuku.net/scrap
- **価格修正**: 砲金(1460)、雑線80%(1300)、雑線60%-65%(960)、VA線(720)、アルミホイール(390)、アルミサッシ(340)、ステンレス304(175)

#### 10. 鴻祥貿易株式会社
- **地域**: 大阪
- **抽出方法**: `kousyo_box`（専用抽出ロジック）
- **取得件数**: 9件（フィルタリング後）
- **URL**: https://kousyo-boueki.jp/scrap_nonferrous.html
- **価格修正**: ステンレス304(175)

#### 11. 株式会社鳳山
- **地域**: 兵庫
- **抽出方法**: `houyama_dl`（専用抽出ロジック）
- **取得件数**: 10件（フィルタリング後）
- **URL**: https://houyama.com/price.html
- **価格修正**: 雑線60%-65%(968)

#### 12. 株式会社 春日商会　富山支店
- **地域**: 富山
- **抽出方法**: `auto`
- **取得件数**: 13件（フィルタリング後）
- **URL**: https://haruhi-shokai.com/scrap_nonferrous2.html

#### 13. 株式会社 春日商会　滋賀支店
- **地域**: 滋賀
- **抽出方法**: `auto`
- **取得件数**: 13件（フィルタリング後）
- **URL**: https://haruhi-shokai.com/scrap_nonferrous3.html

#### 14. 株式会社 春日商会　一宮本社
- **地域**: 愛知
- **抽出方法**: `haruhi_table`（専用抽出ロジック）
- **取得件数**: 12件（フィルタリング後）
- **URL**: https://haruhi-shokai.com/scrap_nonferrous1.html
- **価格修正**: 雑線60%-65%(945)、アルミ缶　プレス(315)

#### 15. 安城貿易（愛知）
- **地域**: 愛知
- **抽出方法**: `auto`
- **取得件数**: 14件（フィルタリング後）
- **URL**: https://www.anjyo-t.com/scrap_metal.html
- **価格修正**: ピカ銅(1700)、砲金(1470)、雑線80%(1270)、雑線60%-65%(920)、VA線(730)、アルミホイール(385)、アルミサッシ(350)、アルミ缶　プレス(260)、ステンレス304(170)
- **⚠️ 重要な注意**: ピカ銅の価格は**1700円/kg**で固定設定されています。`config/price_corrections.yaml`の`add`セクションで設定されており、スクレイピング結果に関係なく常に1700円/kgとして出力されます。価格が変更になった場合は、`config/price_corrections.yaml`の`安城貿易（愛知）`セクションの`add`内の`ピカ銅`の価格を更新してください。

#### 16. 東北キング
- **地域**: 大阪
- **抽出方法**: `touhoku_div`（専用抽出ロジック）
- **取得件数**: 11件（フィルタリング後）
- **特徴**: 複数URL（2つのURL）
- **URL**: 
  - https://touhokuking.com/scrap_copper.html
  - https://touhokuking.com/scrap_nonferrous.html
- **価格修正**: アルミホイール(402)、鉛バッテリー(77)、ステンレス304(150)
- **削除対象**: 雑旋、VA線

#### 17. 株式会社八木
- **地域**: 大阪
- **抽出方法**: `yagi_table`（専用抽出ロジック）
- **取得件数**: 11件（フィルタリング後）
- **特徴**: 2列テーブル構造（1行目=材料名、2行目=価格）
- **URL**: https://yagimetal.com/works/service
- **価格修正**: 並銅(1600)、真鍮(1080)、雑線80%(1300)、雑線60%-65%(960)、ステンレス304(170)
- **削除対象**: 雑旋、鉛バッテリー

#### 18. 株式会社 ヒラノヤ
- **地域**: 大阪
- **抽出方法**: `div_list`
- **取得件数**: 4件（フィルタリング後）
- **URL**: https://hiranoyasan.com/all-items/
- **価格修正**: 並銅(1630)、砲金(1460)、真鍮(1080)、雑線80%(1300)、雑線60%-65%(960)、VA線(720)、アルミホイール(370)、アルミ缶　プレス(150)

---

## 📁 システム構成

### ディレクトリ構造

```
非鉄金属ナビ/スクラップ価格自動取得/
├── scrape_prices_v2.py              # メインスクリプト（全企業対象）
├── scrape_18_companies_to_excel.py  # 18社専用スクリプト（テストシート形式出力）⭐推奨
├── scrape_and_fill_standard_table.py # 「正規の表」シートに記入するスクリプト
├── scrapers/
│   ├── __init__.py
│   ├── base_scraper.py              # 基底クラス
│   ├── category1_scraper.py         # カテゴリ1（テーブル/div構造）
│   └── category2_scraper.py          # カテゴリ2（リスト/div構造、自動抽出）
├── config/
│   ├── sites.yaml                    # 企業設定（35社）
│   ├── target_items.yaml             # 抽出対象アイテム定義（13種類）
│   └── price_corrections.yaml       # 価格修正マッピング（18社分）
├── utils/
│   ├── debug_html.py                 # HTMLデバッグツール
│   ├── html_analyzer.py              # HTML構造分析ツール
│   └── save_html.py                  # HTML保存ツール
├── html_samples/                     # HTMLサンプルファイル
├── price_results_v2_20251104_220253.xlsx  # Excel出力ファイル
├── プライステスト.xlsx                # テスト用Excelファイル（修正価格含む）⭐
├── scrape_log_v2.txt                 # ログファイル
└── requirements.txt                   # 依存パッケージ
```

### 主要スクリプトの説明

#### 1. `scrape_prices_v2.py`
- **用途**: 全企業（35社）の価格を取得してJSON/CSV/Excel形式で出力
- **出力形式**: JSON、CSV、Excel（縦型リスト形式）
- **実行方法**: `python scrape_prices_v2.py`

#### 2. `scrape_18_companies_to_excel.py` ⭐ **推奨**
- **用途**: 実装済み18社の価格を取得してExcelに新規シートとして出力（テストシート形式）
- **出力形式**: Excel（横型表形式：1行目=材料名、2行目以降=企業名と価格）
- **実行方法**: `python scrape_18_companies_to_excel.py`
- **出力先**: `プライステスト.xlsx`の新規シート（`テスト_YYYYMMDD_HHMMSS`）
- **特徴**: 
  - 価格修正マッピングを自動適用
  - 削除対象の材料を自動除外
  - 材料名の正規化を自動実行

#### 3. `scrape_and_fill_standard_table.py`
- **用途**: 18社の価格を取得して「正規の表」シートに記入
- **実行方法**: `python scrape_and_fill_standard_table.py`

---

## ⚙️ 設定ファイルの詳細

### 1. `config/sites.yaml`

企業の設定情報を定義するファイル。

**構造**:
```yaml
sites:
  - name: 企業名
    category: 1 or 2  # 1: カテゴリ1、2: カテゴリ2
    region: 地域名
    price_url: URL
    extractor_type: 抽出方法
    # 複数URLの場合は price_urls: [URL1, URL2, ...]
```

**抽出方法（extractor_type）の種類**:
- `auto`: 自動抽出（最も一般的）
- `div_list`: divカード形式
- `yagi_table`: 八木専用テーブル抽出
- `kaneda_figcaption`: 金田商事専用figcaption抽出
- `touki_dl`: 東起産業専用抽出
- `kousyo_box`: 鴻祥貿易専用抽出
- `houyama_dl`: 株式会社鳳山専用抽出
- `haruhi_table`: 春日商会専用テーブル抽出
- `touhoku_div`: 東北キング専用抽出

**現在の状態**:
- **企業数**: 35社
- **問題点**: 一部の企業名が文字化けしている（要修正）

### 2. `config/target_items.yaml`

抽出対象アイテムの定義とキーワードバリエーションを定義するファイル。

**対象アイテム（13種類）**:
1. ピカ銅
2. 並銅
3. 砲金
4. 真鍮
5. 雑線80%
6. 雑線60%-65%
7. VA線
8. アルミホイール
9. アルミサッシ
10. アルミ缶　バラ
11. アルミ缶　プレス
12. ステンレス304
13. 鉛バッテリー

**最新更新（2025年11月13日）**:
- 各アイテムのキーワードバリエーションを大幅に追加
- Excelのコメントから抽出した実際の品名を追加
- 例：雑線80%に「一本線80%」「80%線」「電線80％」「銅線（80%以上）」などを追加

### 3. `config/price_corrections.yaml`

スクレイピング後に適用される価格修正マッピングを定義するファイル。

**構造**:
```yaml
corrections:
  企業名:
    remove: [削除する材料名]
    add:
      - material: 材料名
        price: 価格
    modify:
      - material: 材料名
        price: 修正価格
        material_new: 新しい材料名（オプション）
```

**最新更新（2025年11月16日）**:
- **修正企業数**: 18社
- Excelファイル「プライステスト.xlsx」の修正行から修正価格を抽出して反映
- 各企業の修正価格を数値のみに正規化して保存
- 削除対象の材料を`remove`セクションに追加

**修正が適用されている企業（18社）**:
1. 眞田鋼業株式会社: 並銅(1500)、ステンレス304(160)
2. 有限会社金田商事: 並銅(1680)、真鍮(1180)、アルミサッシ(346)、ステンレス304(176)など
3. 木村金属（大阪）: 並銅(1640)、削除: ステンレス304
4. 明鑫貿易株式会社: ピカ銅(1690)、ステンレス304(150)など
5. 東起産業（株）: ピカ銅(1730)、ステンレス304(170)など
6. 土金（大阪）: 真鍮(1090)、VA線(740)など
7. 千福商会（大阪）: 砲金(1460)、雑線80%(1300)など
8. 株式会社鳳山: 雑線60%-65%(968)
9. 株式会社 春日商会　一宮本社: 雑線60%-65%(945)
10. 安城貿易（愛知）: **ピカ銅(1700)**、砲金(1470)、雑線80%(1270)など
11. 東北キング: アルミホイール(402)、鉛バッテリー(77)、ステンレス304(150)、削除: VA線
12. 株式会社八木: 並銅(1600)、ステンレス304(170)など
13. 有限会社　八尾アルミセンター: 砲金(1460)、真鍮(1130)など、削除: ステンレス304
14. 株式会社 ヒラノヤ: 並銅(1630)、砲金(1460)など
15. 鴻祥貿易株式会社: ステンレス304(175)

---

## 🚀 スクリプトの使用方法

### 基本的な使用方法

#### 1. 依存関係のインストール

```bash
pip install -r requirements.txt
```

**必要なパッケージ**:
- `requests`: HTTPリクエスト
- `beautifulsoup4`: HTML解析
- `openpyxl`: Excel操作
- `pyyaml`: YAMLファイル読み込み
- `lxml`: HTML解析（BeautifulSoupのパーサー）

#### 2. 18社の価格を取得してExcelに出力（推奨）

```bash
python scrape_18_companies_to_excel.py
```

**出力先**: `プライステスト.xlsx`の新規シート  
**シート名**: `テスト_YYYYMMDD_HHMMSS`  
**出力形式**: テストシート形式（横型表形式）

**実行結果の例**:
```
スクレイピング完了:
  成功: 18/18 社
  失敗: 0/18 社
  取得価格情報総数: 232 件
✓ 18社の取得結果を プライステスト.xlsx のシート 'テスト_20251116_115031' に保存しました（テストシート形式）
```

#### 3. 全企業の価格を取得（35社）

```bash
python scrape_prices_v2.py
```

**出力形式**: JSON、CSV、Excel（縦型リスト形式）

#### 4. 「正規の表」シートに記入

```bash
python scrape_and_fill_standard_table.py
```

**出力先**: `price_results_v2_20251104_220253.xlsx`の「正規の表」シート

---

## 📅 最新の更新内容（2025年11月16日）

### 1. Excelファイル「プライステスト.xlsx」への出力機能追加

**更新内容**:
- `scrape_18_companies_to_excel.py`の出力先を`プライステスト.xlsx`に変更
- 既存のExcelファイルに新しいシートとして追加する機能を実装

**使用方法**:
```bash
python scrape_18_companies_to_excel.py
```

### 2. 価格修正マッピングの更新（Excel修正行から自動抽出）

**更新内容**:
- Excelファイル「プライステスト.xlsx」の修正行（例：「並銅　修正」「真鍮　修正」）から修正価格を自動抽出
- 抽出した修正データを`config/price_corrections.yaml`に反映
- 削除対象の材料（「削除」と記載された材料）を`remove`セクションに追加

**更新された企業（9社）**:
1. 眞田鋼業株式会社: 並銅(1500)、ステンレス304(160)
2. 有限会社金田商事: 真鍮(1180)
3. 木村金属（大阪）: 削除: ステンレス304
4. 明鑫貿易株式会社: ステンレス304(150)
5. 東起産業（株）: ステンレス304(170)
6. 鴻祥貿易株式会社: ステンレス304(175)
7. 東北キング: 削除: VA線、ステンレス304(150)
8. 株式会社八木: ステンレス304(170)
9. 有限会社　八尾アルミセンター: 削除: ステンレス304

### 3. 削除処理の改善

**更新内容**:
- `apply_price_corrections()`関数の削除処理を改善（材料名の正規化を追加）
- `save_to_excel_new_sheet()`関数でExcel出力時に削除対象の材料を除外する処理を追加
- 材料名の正規化（`MATERIAL_MAPPING`を使用）を適用して削除処理を実行

**更新されたファイル**: `scrape_18_companies_to_excel.py`

**改善点**:
- 削除処理が正しく機能するようになった
- Excel出力時に削除対象の材料が表示されなくなった

### 4. 価格修正適用ロジックの改善

**更新内容**:
- 材料名の正規化を追加（マッピングを使用）
- 部分一致検索を改善
- 価格の数値正規化を追加

**更新されたファイル**: `scrape_18_companies_to_excel.py`の`apply_price_corrections()`関数

### 5. 安城貿易（愛知）のピカ銅価格修正 ⚠️ **重要**

**更新内容**:
- 安城貿易（愛知）のピカ銅の価格を**1630円/kg → 1700円/kg**に修正
- `config/price_corrections.yaml`の`安城貿易（愛知）`セクションの`add`内の`ピカ銅`の価格を更新
- スクレイピング結果に関係なく、常に1700円/kgとして出力されるように設定

**更新日**: 2025年11月16日

**更新されたファイル**: `config/price_corrections.yaml`

**注意事項**:
- ピカ銅の価格は`add`セクションで固定設定されているため、スクレイピング結果に関係なく常に1700円/kgとして出力されます
- 価格が変更になった場合は、必ず`config/price_corrections.yaml`の`安城貿易（愛知）`セクションの`add`内の`ピカ銅`の`price`を更新してください

---

## 🔑 重要な実装内容

### 1. 価格修正マッピングの適用

**ファイル**: `scrape_18_companies_to_excel.py`の`apply_price_corrections()`関数

**処理内容**:
1. スクレイピング結果に対して価格修正マッピングを適用
2. 材料名の正規化（マッピングを使用）
3. 部分一致検索で材料名をマッチング
4. 価格を数値のみに正規化

**修正の種類**:
- **remove**: 不要な材料を削除
- **add**: 新しい材料を追加
- **modify**: 既存の材料の価格を修正

### 2. 材料名の正規化

**ファイル**: `scrape_18_companies_to_excel.py`の`MATERIAL_MAPPING`

**処理内容**:
- 取得した材料名を標準的な材料名にマッピング
- 例：「ピカ線」→「ピカ銅」、「三本線（A）」→「雑線60%-65%」

### 3. 企業名の正規化

**ファイル**: `scrape_18_companies_to_excel.py`の`normalize_company_name()`関数

**処理内容**:
- 文字化けした企業名を正規化
- 例：「明鑫貿易�式会社」→「明鑫貿易株式会社」

### 4. 専用抽出ロジック

**カテゴリ2の専用抽出メソッド**:
- `extract_from_yagi_table()`: 八木専用
- `extract_from_kaneda_figcaption()`: 金田商事専用
- `extract_from_touki_dl()`: 東起産業専用
- `extract_from_kousyo_box()`: 鴻祥貿易専用
- `extract_from_houyama_dl()`: 株式会社鳳山専用
- `extract_from_haruhi_table()`: 春日商会専用
- `extract_from_touhoku_div()`: 東北キング専用

### 5. 削除処理の実装

**ファイル**: `scrape_18_companies_to_excel.py`の`apply_price_corrections()`関数と`save_to_excel_new_sheet()`関数

**処理内容**:
1. `apply_price_corrections()`関数で削除対象の材料を価格データから削除
2. `save_to_excel_new_sheet()`関数でExcel出力時に削除対象の材料を除外
3. 材料名の正規化を適用して削除処理を実行

**削除対象の材料**:
- 木村金属（大阪）: ステンレス304
- 東北キング: VA線
- 有限会社　八尾アルミセンター: ステンレス304

---

## 💰 価格修正の適用方法

### Excelファイルから修正データを抽出する方法

1. **Excelファイルを開く**
   - `プライステスト.xlsx`を開く
   - 最新のテストシートを確認

2. **修正行に価格を記入**
   - 各材料の右側に「〇〇　修正」という行を作成
   - 例：「並銅　修正」「真鍮　修正」「VA線　修正」「ステンレス304　修正」
   - 修正行に正しい価格を記入
   - 削除する場合は「削除」と記入

3. **修正データを抽出して反映**
   - 以下のPythonスクリプトを実行して修正データを抽出
   - 抽出したデータを`config/price_corrections.yaml`に反映

**修正データ抽出スクリプト**:
```python
import openpyxl
import yaml

# Excelから修正データを抽出
wb = openpyxl.load_workbook('プライステスト.xlsx')
sheet = wb.worksheets[-1]  # 最新のシート

# ヘッダー行から修正列を特定
correction_columns = {}
for col in range(1, sheet.max_column + 1):
    cell = sheet.cell(row=1, column=col)
    if cell.value and '修正' in str(cell.value):
        base_material = str(cell.value).replace('修正', '').replace('　', '').strip()
        correction_columns[base_material] = col

# 各企業の修正価格を抽出
excel_corrections = {}
for row in range(2, sheet.max_row + 1):
    company_name = sheet.cell(row=row, column=1).value
    if not company_name:
        continue
    
    company_name = str(company_name).strip()
    if company_name not in excel_corrections:
        excel_corrections[company_name] = {'modify': [], 'remove': []}
    
    # 各修正列の価格を確認
    for material, corr_col in correction_columns.items():
        corr_cell = sheet.cell(row=row, column=corr_col)
        if corr_cell.value:
            price = corr_cell.value
            if isinstance(price, (int, float)):
                price_str = str(int(price))
            else:
                price_str = str(price).strip()
            
            if price_str and price_str != 'None':
                if price_str == '削除':
                    excel_corrections[company_name]['remove'].append(material)
                else:
                    excel_corrections[company_name]['modify'].append({
                        'material': material,
                        'price': price_str
                    })

# 既存の価格修正マッピングを読み込む
with open('config/price_corrections.yaml', 'r', encoding='utf-8') as f:
    corrections = yaml.safe_load(f)

# Excelから抽出した修正を適用
for company_name, excel_data in excel_corrections.items():
    if company_name not in corrections['corrections']:
        corrections['corrections'][company_name] = {}
    
    # removeを追加/更新
    if excel_data['remove']:
        if 'remove' not in corrections['corrections'][company_name]:
            corrections['corrections'][company_name]['remove'] = []
        for material in excel_data['remove']:
            if material not in corrections['corrections'][company_name]['remove']:
                corrections['corrections'][company_name]['remove'].append(material)
    
    # modifyを追加/更新
    if excel_data['modify']:
        if 'modify' not in corrections['corrections'][company_name]:
            corrections['corrections'][company_name]['modify'] = []
        
        # 既存のmodifyエントリを更新または追加
        for excel_item in excel_data['modify']:
            material = excel_item['material']
            price = excel_item['price']
            
            # 既存のエントリを探す
            found = False
            for i, existing_item in enumerate(corrections['corrections'][company_name]['modify']):
                if existing_item.get('material') == material:
                    # 既存のエントリを更新
                    corrections['corrections'][company_name]['modify'][i]['price'] = price
                    found = True
                    break
            
            if not found:
                # 新しいエントリを追加
                corrections['corrections'][company_name]['modify'].append({
                    'material': material,
                    'price': price
                })

# ファイルに保存
with open('config/price_corrections.yaml', 'w', encoding='utf-8') as f:
    yaml.dump(corrections, f, allow_unicode=True, default_flow_style=False, sort_keys=False)
```

### 手動で価格修正マッピングを更新する方法

1. **`config/price_corrections.yaml`を開く**
2. **該当する企業のセクションを編集**
3. **修正内容を追加**
   - `modify`: 価格を修正する場合
   - `remove`: 材料を削除する場合
   - `add`: 新しい材料を追加する場合

**例**:
```yaml
corrections:
  眞田鋼業株式会社:
    modify:
    - material: 並銅
      price: '1500'
    - material: ステンレス304
      price: '160'
  木村金属（大阪）:
    remove:
    - ステンレス304
    modify:
    - material: 波銅
      price: 1640円/kg(税込)
      material_new: 並銅
  安城貿易（愛知）:
    add:
    - material: ピカ銅
      price: 1700円/kg  # ⚠️ 重要: ピカ銅は固定価格として設定
    modify:
    - material: 砲金
      price: '1470'
```

---

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### 1. 価格が取得できない

**原因**:
- `config/sites.yaml`の`extractor_type`が正しく設定されていない
- HTML構造が変更された

**解決方法**:
1. `scrape_log_v2.txt`を確認してエラーメッセージを確認
2. `utils/html_analyzer.py`でHTML構造を分析
3. `html_samples/`にHTMLサンプルを保存して確認
4. 必要に応じて専用抽出ロジックを追加

#### 2. 価格修正が適用されない

**原因**:
- 材料名がマッピングに一致しない
- 企業名が正規化されていない

**解決方法**:
1. `config/price_corrections.yaml`の企業名を確認
2. `config/target_items.yaml`に材料名のキーワードを追加
3. `scrape_18_companies_to_excel.py`の`MATERIAL_MAPPING`を確認

#### 3. 削除処理が機能しない

**原因**:
- 材料名が正規化されていない
- 削除対象の材料名が`remove`セクションに正しく記載されていない

**解決方法**:
1. `config/price_corrections.yaml`の`remove`セクションを確認
2. 材料名が正規化されているか確認（`MATERIAL_MAPPING`を参照）
3. `scrape_18_companies_to_excel.py`の削除処理ロジックを確認

#### 4. 文字化け

**原因**:
- ファイルのエンコーディングが正しくない

**解決方法**:
1. ファイルをUTF-8エンコーディングで保存
2. `scrape_18_companies_to_excel.py`の`COMPANY_NAME_MAPPING`で正規化

#### 5. Excelファイルが開けない

**原因**:
- ファイルが破損している
- 別のプロセスがファイルを使用している

**解決方法**:
1. ファイルを閉じてから再度実行
2. バックアップファイルから復元

---

## 🎯 次のステップ

### 優先度：高

1. **未実装企業の実装（17社）**
   - 内田産業株式会社（複数URL、6つのURL）
   - 日中金属貿易
   - その他15社

2. **sites.yamlの文字化け修正**
   - 企業名の文字化けを修正

### 優先度：中

3. **定期的な価格取得の自動化**
   - スケジュール実行の設定
   - エラー通知の実装

4. **抽出精度の向上**
   - 一部の企業で抽出精度の改善が必要

### 優先度：低

5. **動作確認**
   - 設定済み企業の定期的な動作確認

6. **エラー対応**
   - 抽出ロジック改善が必要な企業の対応

---

## 📝 重要な注意事項

### 1. 価格修正マッピングの適用タイミング

- 価格修正マッピングはスクレイピング**後**に適用される
- `scrape_18_companies_to_excel.py`では自動的に適用される
- 修正内容は`config/price_corrections.yaml`で管理

### 2. 材料名のマッピング

- 取得した材料名は`MATERIAL_MAPPING`で正規化される
- 正規化後の材料名が`MATERIAL_COLUMNS`に含まれている場合のみ出力される

### 3. 企業名の正規化

- 文字化けした企業名は`normalize_company_name()`で正規化される
- `COMPANY_NAME_MAPPING`でマッピングを定義

### 4. Excel出力形式

- **テストシート形式**: 横型表形式（1行目=材料名、2行目以降=企業名と価格）
- **リスト形式**: 縦型リスト形式（各行=企業名、材料名、価格）

### 5. ログファイル

- すべてのログは`scrape_log_v2.txt`に記録される
- エラーが発生した場合はログファイルを確認

### 6. 削除処理の注意点

- 削除対象の材料は`config/price_corrections.yaml`の`remove`セクションに記載
- 削除処理は材料名の正規化を適用して実行される
- Excel出力時に削除対象の材料は表示されない

### 7. 安城貿易（愛知）のピカ銅価格について ⚠️ **重要**

- **ピカ銅の価格は1700円/kgで固定設定されています**
- `config/price_corrections.yaml`の`安城貿易（愛知）`セクションの`add`内で設定されています
- スクレイピング結果に関係なく、常に1700円/kgとして出力されます
- **価格が変更になった場合の更新方法**:
  1. `config/price_corrections.yaml`を開く
  2. `安城貿易（愛知）`セクションの`add`内の`ピカ銅`の`price`を更新
  3. 例: `price: 1700円/kg` → `price: 新しい価格円/kg`
  4. スクリプトを再実行して確認
- **注意**: 以前は1630円/kgに設定されていましたが、2025年11月16日に1700円/kgに修正されました。次回以降、価格が変更になった場合は必ず`config/price_corrections.yaml`を更新してください。

---

## 📖 参考ドキュメント

- `PROJECT_STATUS.md`: プロジェクトの最新状態
- `実装進捗.md`: 詳細な実装履歴
- `設定完了企業リスト.md`: 設定完了企業の詳細リスト
- `引き継ぎドキュメント.md`: 以前の引継書
- `引き継ぎ書_完全版_20251113.md`: 2025年11月13日の引継書

---

## 💡 使い方のコツ

### 新しい作業を始める時

1. **この引継書を読む** - 最新の状態を把握
2. **`scrape_18_companies_to_excel.py`を実行** - 18社の価格を取得
3. **Excelファイルを確認** - 出力結果を確認

### 価格修正を追加する時

1. Excelファイルで修正価格を記入
   - 各材料の右側に「〇〇　修正」という行を作成
   - 修正行に正しい価格を記入
   - 削除する場合は「削除」と記入
2. コメントに実際の品名を記入（オプション）
3. `config/price_corrections.yaml`を更新
   - Excelから修正データを抽出するスクリプトを実行
   - または手動で`config/price_corrections.yaml`を編集
4. `config/target_items.yaml`にキーワードを追加（必要に応じて）
5. スクリプトを再実行して確認

### 新しい企業を追加する時

1. `config/sites.yaml`に企業情報を追加
2. HTML構造を分析（`utils/html_analyzer.py`を使用）
3. 必要に応じて専用抽出ロジックを追加
4. 動作確認
5. `config/price_corrections.yaml`に修正マッピングを追加（必要に応じて）

---

## 📞 サポート情報

### ログファイルの場所
- `scrape_log_v2.txt`: すべてのログが記録される

### Excelファイルの場所
- `price_results_v2_20251104_220253.xlsx`: メインのExcelファイル
- `プライステスト.xlsx`: テスト用Excelファイル（修正価格含む）⭐

### 設定ファイルの場所
- `config/sites.yaml`: 企業設定
- `config/target_items.yaml`: 対象アイテム定義
- `config/price_corrections.yaml`: 価格修正マッピング

---

## ✅ チェックリスト

### スクレイピング実行前

- [ ] `requirements.txt`の依存パッケージがインストールされている
- [ ] `config/sites.yaml`が最新の状態である
- [ ] `config/price_corrections.yaml`が最新の状態である
- [ ] `config/target_items.yaml`が最新の状態である

### スクレイピング実行後

- [ ] `scrape_log_v2.txt`でエラーがないか確認
- [ ] Excelファイルが正しく出力されているか確認
- [ ] 価格修正が正しく適用されているか確認
- [ ] 削除対象の材料が正しく除外されているか確認
- [ ] 取得件数が期待通りか確認

### 価格修正を追加する時

- [ ] Excelファイルの修正行に正しい価格を記入
- [ ] 削除する場合は「削除」と記入
- [ ] `config/price_corrections.yaml`を更新
- [ ] スクリプトを再実行して確認

---

## 📊 最終テスト結果（2025年11月16日）

### 実行結果

- **成功**: 18/18社
- **失敗**: 0/18社
- **取得価格情報総数**: 232件（削除処理適用後）

### 価格修正の適用状況

- **修正適用企業数**: 18社
- **削除対象企業数**: 3社（木村金属（大阪）、東北キング、有限会社　八尾アルミセンター）

### 確認済みの修正内容

1. **眞田鋼業株式会社**: 並銅(1500)、ステンレス304(160) - ✅適用済み
2. **有限会社金田商事**: 真鍮(1180) - ✅適用済み、VA線は無記入でOK
3. **木村金属（大阪）**: ステンレス304削除 - ✅適用済み
4. **明鑫貿易株式会社**: ステンレス304(150) - ✅適用済み
5. **東起産業（株）**: ステンレス304(170) - ✅適用済み
6. **鴻祥貿易株式会社**: ステンレス304(175) - ✅適用済み
7. **東北キング**: VA線削除、ステンレス304(150) - ✅適用済み
8. **株式会社八木**: ステンレス304(170) - ✅適用済み
9. **有限会社　八尾アルミセンター**: ステンレス304削除 - ✅適用済み

---

**この引継書は次のチャットセッションで必ず参照してください。**

**最終更新**: 2025年11月16日  
**次回更新予定**: 未実装企業の実装完了時、または重要な機能追加時

