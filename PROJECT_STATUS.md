# プロジェクト状態（最新）

**最終更新**: 2025年11月16日  
**最新の引継書**: `引き継ぎ書_完全版_20251116.md`を参照してください

## 📊 現在の状況サマリー

- **総企業数**: **35社**（PDFから確認済み、これが全ての対象企業）
- **実装済み（動作確認済み）**: **18社**（全社で価格取得成功、価格修正マッピング適用済み）
- **未実装**: **17社**（HTML構造分析や抽出ロジック改善が必要）
- **複数URL企業**: 10社
- **最新更新**: 2025年11月16日 - 価格修正マッピング更新（Excel修正行から自動抽出）、削除処理改善、プライステスト.xlsxへの出力機能追加

## 🎯 プロジェクトの目的

非鉄金属スクラップの価格情報を複数の企業サイトから自動取得し、JSON/CSV/Excel形式で出力するシステム。

## 📁 主要ファイル構成

```
├── scrape_prices_v2.py              # メインスクリプト（全企業対象）
├── scrape_18_companies_to_excel.py  # 18社専用スクリプト（テストシート形式出力）⭐推奨
├── scrape_and_fill_standard_table.py # 「正規の表」シートに記入するスクリプト
├── scrapers/
│   ├── base_scraper.py               # 基底クラス
│   ├── category1_scraper.py          # カテゴリ1（テーブル/div構造）
│   └── category2_scraper.py          # カテゴリ2（リスト/div構造、自動抽出）
├── config/
│   ├── sites.yaml                    # 企業設定（35社）
│   ├── target_items.yaml             # 抽出対象アイテム定義（13種類）
│   └── price_corrections.yaml        # 価格修正マッピング（18社分）
├── price_results_v2_20251104_220253.xlsx  # Excel出力ファイル
├── プライステスト.xlsx                # テスト用Excelファイル（修正価格含む）⭐推奨出力先
└── 引き継ぎ書_完全版_20251113.md      # 完全版引継書
```

## ⚙️ 実行方法

```bash
# 依存関係のインストール
pip install -r requirements.txt

# 18社の価格を取得してExcelに出力（推奨）
python scrape_18_companies_to_excel.py
# 出力先: プライステスト.xlsx の新規シート（テスト_YYYYMMDD_HHMMSS）

# 全企業の価格を取得（35社）
python scrape_prices_v2.py

# 「正規の表」シートに記入
python scrape_and_fill_standard_table.py
```

## 🔧 既知の問題

1. **sites.yamlの文字化け**: 一部の企業名が文字化けしている（要修正）
2. **三和金属株式会社**: PDF埋め込みタイプで価格ページURL未設定
3. **未実装企業**: 17社が未実装（HTML構造分析や抽出ロジック改善が必要）
4. **価格修正の適用**: 一部の企業で価格修正が完全に適用されていない可能性がある（要確認）

## 📝 直近の作業履歴

- ✅ **2025年11月16日**: Excelファイル「プライステスト.xlsx」への出力機能を追加
- ✅ **2025年11月16日**: Excel修正行から価格修正データを自動抽出する機能を実装
- ✅ **2025年11月16日**: 価格修正マッピングを更新（9社の修正価格を反映、削除対象を追加）
- ✅ **2025年11月16日**: 削除処理を改善（材料名の正規化を適用、Excel出力時に削除対象を除外）
- ✅ **2025年11月16日**: 完全版引継書を更新（2025年11月16日版）
- ✅ **2025年11月13日**: 価格修正マッピングを更新（12社の修正価格を反映）
- ✅ **2025年11月13日**: 材料名マッピングを大幅に更新（Excelコメントから実際の品名を抽出）
- ✅ **2025年11月13日**: 価格修正適用ロジックを改善（材料名正規化、部分一致検索改善）
- ✅ **2025年11月13日**: 18社専用スクリプト（`scrape_18_companies_to_excel.py`）を作成
- ✅ **2025年11月13日**: テストシート形式でのExcel出力機能を実装
- ✅ **2025年11月13日**: 完全版引継書を作成
- ✅ 2024年11月10日: 18社すべてで価格取得に成功（177件の価格情報を取得）
- ✅ 2024年11月10日: category2_scraper.pyの実装を復元・改善
- ✅ 2024年11月10日: 株式会社八木のextract_from_yagi_tableメソッドを修正（2列×2行テーブル構造に対応）
- ✅ 2024年11月10日: extract_autoメソッドを改善（複数価格対応、材料名クリーンアップ）
- ✅ 2024年11月10日: 「正規の表」シートに18社の価格データを記入するスクリプト（fill_standard_table.py）を作成
- ✅ 2024年11月10日: Excel「正規の表」シートに罫線を追加
- ✅ 2024年11月7日: 金田商事の税込変換・最高価格のみ抽出を実装完了
- ✅ 2024年11月7日: 金田商事の「銅（並）銅管」を「並銅」として認識するよう修正
- ✅ 2024年11月7日: 実装状況の整理と引き継ぎドキュメント作成
- ✅ 2024年11月6日: 株式会社八木を実装完了（yagi_table抽出ロジック）
- ✅ 2024年11月6日: 有限会社金田商事を実装完了（kaneda_figcaption抽出ロジック）
- ✅ 2024年11月6日: 対象アイテム設定更新（70%線除外、60%線追加）
- ✅ 2024年11月6日: Excelファイルに八木・金田商事の価格情報を追加
- ✅ PDFから全企業リスト確認完了（35社が全て）
- ✅ CSVから全企業追加完了
- ✅ 複数URL対応実装
- ✅ 価格修正マッピング機能実装
- ✅ Excel出力機能実装

## 🚀 次のステップ

### 優先度：高
1. **内田産業株式会社の実装**（HTML構造分析が必要、複数URL）
2. **日中金属貿易の実装**（HTML構造分析が必要）

### 優先度：中
3. **sites.yamlの文字化け修正**（企業名の文字化けを修正）
4. **未実装企業の実装**（残り17社）
5. **「正規の表」シートの定期更新**（定期的な価格取得と記入の自動化）

### 優先度：低
6. **動作確認**（設定済み企業の定期的な動作確認）
7. **エラー対応**（抽出ロジック改善が必要な企業の対応）

## 💡 重要な決定事項

- **抽出方法**: 設定ファイルベース（sites.yaml）
- **フィルタリング**: target_items.yamlで対象アイテムを定義
- **後処理**: price_corrections.yamlで価格情報を修正
- **出力形式**: JSON、CSV、Excel（複数シート対応）

## 📋 対象アイテム（13種類）

価格自動取得の対象は以下の13種類：
1. ピカ銅 2. 並銅 3. 砲金 4. 真鍮 5. 雑線80% 6. 雑線60%-65% 7. VA線
8. アルミホイール 9. アルミサッシ 10. アルミ缶バラ 11. アルミ缶プレス
12. ステンレス304 13. 鉛バッテリー

**注意**: アイテム名は完全一致ではない（例：ピカ銅→ピカ線）。価格相場などを含め総合的に判断が必要。

## 📞 トラブルシューティング

- **価格が取得できない**: `config/sites.yaml`の`extractor_type`を確認
- **文字化け**: CSVファイルのエンコーディングを確認（update_sites_from_csv.pyで自動検出）
- **エラーログ**: `scrape_log_v2.txt`を確認

## 📖 使い方ガイド

### 新しい作業を始める時

1. **`引き継ぎ書_完全版_20251113.md`を読む** - 最新の完全版引継書を参照
2. **`PROJECT_STATUS.md`を読む** - 現在の状態を把握
3. **`WORK_LOG.md`を確認** - 最近の作業内容を確認
4. **必要に応じて`実装進捗.md`を参照** - 詳細な実装履歴

### 作業中に状態を更新する時

1. **重要な変更があったら** - `PROJECT_STATUS.md`の「🔧 既知の問題」や「🚀 次のステップ」を更新
2. **作業が完了したら** - `WORK_LOG.md`に作業内容を記録
3. **詳細な実装情報** - `実装進捗.md`に追記

### 引き継ぎのコツ

- **新しいチャットを始める時**: 「`引き継ぎ書_完全版_20251116.md`を読んで最新の状態を教えて」と指示
- **重要な決定**: `PROJECT_STATUS.md`の「💡 重要な決定事項」に記録
- **問題が発生したら**: `PROJECT_STATUS.md`の「🔧 既知の問題」に追加
- **価格修正を追加する時**: Excelファイルで修正価格を記入し、`config/price_corrections.yaml`を更新

